<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adjusted PE Breakdown - {{ ticker }}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        /* CSS Custom Properties for Theming */
        :root {
            /* Default (Cyber) Theme Variables */
            --bg-primary: #0a0a0a;
            --bg-secondary: #0d0d0d;
            --bg-tertiary: #0a0a0a;
            --bg-gradient: radial-gradient(circle at 20% 50%, rgba(0, 200, 220, 0.03) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(200, 0, 200, 0.03) 0%, transparent 50%), radial-gradient(circle at 40% 20%, rgba(120, 0, 200, 0.03) 0%, transparent 50%);
            --text-primary: #7dd3fc;
            --text-secondary: #a5d8ff;
            --text-muted: #7dd3fc;
            --accent-primary: #7dd3fc;
            --accent-secondary: #c4b5fd;
            --accent-success: #4ade80;
            --accent-danger: #f87171;
            --accent-warning: #fbbf24;
            --border-color: rgba(125, 211, 252, 0.3);
            --border-light: rgba(125, 211, 252, 0.4);
            --shadow-color: rgba(125, 211, 252, 0.15);
            --shadow-inset: rgba(125, 211, 252, 0.03);
            --glow-primary: rgba(125, 211, 252, 0.15);
            --glow-secondary: rgba(196, 181, 253, 0.3);
            --input-bg: #0a0a0a;
            --button-bg: rgba(125, 211, 252, 0.1);
            --card-bg: #0a0a0a;
            --header-bg: linear-gradient(135deg, #0a0a0a 0%, #1a0a1a 100%);
            --animation-glow: pulse-glow 4s ease-in-out infinite;
            --table-hover-bg: rgba(125, 211, 252, 0.05);
            --table-header-bg: rgba(125, 211, 252, 0.1);
            --container-bg: #111111;
        }

        /* Light Theme Variables */
        body.light {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #ffffff;
            --bg-gradient: none;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #6c757d;
            --accent-primary: #007bff;
            --accent-secondary: #0056b3;
            --accent-success: #28a745;
            --accent-danger: #dc3545;
            --accent-warning: #fbbf24;
            --border-color: #dee2e6;
            --border-light: #ced4da;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shadow-inset: rgba(255, 255, 255, 0.8);
            --glow-primary: rgba(0, 123, 255, 0.25);
            --glow-secondary: rgba(0, 123, 255, 0.3);
            --input-bg: #ffffff;
            --button-bg: rgba(0, 123, 255, 0.1);
            --card-bg: #f8f9fa;
            --header-bg: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            --animation-glow: none;
            --table-hover-bg: rgba(0, 123, 255, 0.05);
            --table-header-bg: rgba(0, 123, 255, 0.1);
            --container-bg: #ffffff;
        }

        /* High Contrast Theme Variables */
        body.high-contrast {
            --bg-primary: #000000;
            --bg-secondary: #111111;
            --bg-tertiary: #000000;
            --bg-gradient: none;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #cccccc;
            --accent-primary: #ffffff;
            --accent-secondary: #ffffff;
            --accent-success: #ffffff;
            --accent-danger: #ff6666;
            --accent-warning: #cccccc;
            --border-color: var(--text-primary);
            --border-light: #ffffff;
            --shadow-color: rgba(255, 255, 255, 0.1);
            --shadow-inset: rgba(255, 255, 255, 0.02);
            --glow-primary: rgba(255, 255, 255, 0.1);
            --glow-secondary: rgba(255, 255, 255, 0.3);
            --input-bg: #000000;
            --button-bg: #222222;
            --card-bg: #1a1a1a;
            --header-bg: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            --animation-glow: pulse-glow 4s ease-in-out infinite;
            --table-hover-bg: rgba(255, 255, 255, 0.05);
            --table-header-bg: rgba(255, 255, 255, 0.1);
            --container-bg: #111111;
        }

            /* Default (Cyber) Theme Variables */
            --bg-primary: #0a0a0a;
            --bg-secondary: #0d0d0d;
            --bg-tertiary: #0a0a0a;
            --text-primary: #7dd3fc;
            --text-secondary: #a5d8ff;
            --text-muted: #7dd3fc;
            --accent-primary: #7dd3fc;
            --accent-secondary: #c4b5fd;
            --accent-success: #4ade80;
            --accent-danger: #f87171;
            --border-color: rgba(125, 211, 252, 0.3);
            --border-light: rgba(125, 211, 252, 0.4);
            --shadow-color: rgba(125, 211, 252, 0.15);
            --shadow-inset: rgba(125, 211, 252, 0.03);
            --glow-primary: rgba(125, 211, 252, 0.15);
            --glow-secondary: rgba(196, 181, 253, 0.3);
            --input-bg: #0a0a0a;
            --button-bg: rgba(125, 211, 252, 0.1);
            --card-bg: #0a0a0a;
            --header-bg: linear-gradient(135deg, #0a0a0a 0%, #1a0a1a 100%);
            --animation-glow: pulse-glow 4s ease-in-out infinite;
        }

        /* Light Theme Variables */
        body.light {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #6c757d;
            --accent-primary: #007bff;
            --accent-secondary: #0056b3;
            --accent-success: #28a745;
            --accent-danger: #dc3545;
            --border-color: #dee2e6;
            --border-light: #ced4da;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shadow-inset: rgba(255, 255, 255, 0.8);
            --glow-primary: rgba(0, 123, 255, 0.25);
            --glow-secondary: rgba(0, 123, 255, 0.3);
            --input-bg: #ffffff;
            --button-bg: rgba(0, 123, 255, 0.1);
            --card-bg: #f8f9fa;
            --header-bg: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            --animation-glow: none;
        }

        /* High Contrast Theme Variables */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            background-image:
                radial-gradient(circle at 20% 50%, rgba(0, 200, 220, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(200, 0, 200, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(120, 0, 200, 0.03) 0%, transparent 50%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        /* High Contrast Black Background & White Text Theme */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid rgba(from var(--border-color) r g b / 0.3); text-align: left; }
        th { background: rgba(125, 211, 252, 0.08); color: var(--text-secondary); }
        tr:hover { background: var(--table-hover-bg); }
        .label { color: var(--text-secondary); }
        .muted { color: var(--text-muted); font-size: 0.95em; }
        .error { color: var(--accent-danger); text-align: center; padding: 20px; }
        .loading { text-align: center; padding: 20px; color: var(--text-muted); }
    </style>
</head>
<body>
    <div class="container">
        <div class="theme-switcher">
            <select class="theme-dropdown" id="themeSelect" onchange="setTheme(this.value)">
                <option value="dark">üåô Cyber</option>
                <option value="light">‚òÄÔ∏è Light</option>
                <option value="high-contrast">‚ö´ High Contrast</option>
            </select>
        </div>
        <div class="header">
            <h1>Adjusted PE Breakdown</h1>
            <p>{{ ticker }}</p>
            <button onclick="history.back()" class="back-link">‚Üê Back</button>
        </div>
        <div class="content" id="content">
            <div class="loading">Loading...</div>
        </div>
    </div>

    <script>
        const ticker = '{{ ticker }}';

        function fmt(value, decimals = 2) {
            if (value === null || value === undefined) return 'N/A';
            const num = Number(value);
            if (Number.isNaN(num)) return 'N/A';
            return num.toFixed(decimals);
        }

        function fmtPercent(value, decimals = 2) {
            if (value === null || value === undefined) return 'N/A';
            return (value * 100).toFixed(decimals) + '%';
        }

        function fmtSuffix(value, decimals = 2) {
            if (value === null || value === undefined) return 'N/A';
            const num = Number(value);
            if (Number.isNaN(num)) return 'N/A';
            const abs = Math.abs(num);
            let suffix = '';
            let scaled = num;
            if (abs >= 1_000_000_000) {
                scaled = num / 1_000_000_000;
                suffix = 'B';
            } else if (abs >= 1_000_000) {
                scaled = num / 1_000_000;
                suffix = 'M';
            } else if (abs >= 1_000) {
                scaled = num / 1_000;
                suffix = 'K';
            }
            return scaled.toFixed(decimals) + suffix;
        }

        function fmtMoney(value, decimals = 2) {
            if (value === null || value === undefined) return 'N/A';
            const num = Number(value);
            if (Number.isNaN(num)) return 'N/A';
            return '$' + fmtSuffix(num, decimals);
        }

        function render(data) {
            const contentDiv = document.getElementById('content');
            const ratio = data.adjusted_pe_ratio;
            const b = data.breakdown || {};

            const fields = [
                // Step 1: Base TTM operating income calculation
                { label: 'TTM Operating Income', value: fmtMoney(b.ttm_operating_income) },
                { label: 'TTM Depreciation & Amortization (DA)', value: fmtMoney(b.ttm_da) },
                { label: 'TTM Capex', value: fmtMoney(b.ttm_capex) },
                { label: 'Adjustment (if DA exceeds Capex)', value: fmtMoney(b.adjustment) },
                { label: 'Adjusted Operating Income', value: fmtMoney(b.adjusted_operating_income) },

                // Step 2: Apply tax rate
                { label: 'Median Tax Rate (5yr)', value: fmtPercent(b.median_tax_rate, 2) },
                { label: 'Adjusted Earnings', value: fmtMoney(b.adjusted_oi_after_tax) },

                // Step 3: Get QuickFS base data
                { label: 'QuickFS EV (latest)', value: fmtMoney(b.quickfs_ev) },
                { label: 'QuickFS Market Cap (latest)', value: fmtMoney(b.quickfs_market_cap) },
                { label: 'EV Difference (EV - Market Cap)', value: fmtMoney(b.ev_difference) },

                // Step 4: Get current market data
                { label: 'Share Count (latest QuickFS)', value: fmtSuffix(b.share_count, 2) },
                { label: 'Current Price (yfinance)', value: b.current_price !== undefined && b.current_price !== null ? '$' + fmt(b.current_price) : 'N/A' },

                // Step 5: Calculate updated market cap
                { label: 'Updated Market Cap', value: fmtMoney(b.updated_market_cap) },

                // Step 6: Final EV Adjustment
                { label: 'Updated EV (with current price)', value: fmtMoney(b.updated_ev) },
            ];

            contentDiv.innerHTML = `
                <div class="card">
                    <h2>Adjusted PE Ratio</h2>
                    <div class="value">${ratio !== null && ratio !== undefined ? fmt(ratio) : 'N/A'}</div>
                    <div class="muted">Click any ticker to recalculate from QuickFS/yfinance if data is missing.</div>
                </div>
                <div class="card">
                    <h2>TTM Components</h2>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>Item</th><th>Value</th></tr></thead>
                            <tbody>
                                ${fields.map(f => `<tr><td class="label">${f.label}</td><td>${f.value}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        fetch(`/api/adjusted_pe/${ticker}`)
            .then(r => r.json())
            .then(res => {
                const contentDiv = document.getElementById('content');
                if (!res.success) {
                    contentDiv.innerHTML = `<div class="error">${res.message || 'Adjusted PE data not available'}</div>`;
                    return;
                }
                render(res);
            })
            .catch(err => {
                document.getElementById('content').innerHTML = `<div class="error">Error: ${err.message}</div>`;
            });

        // Theme switching functionality
        function setTheme(theme) {
            const body = document.body;
            const themeSelect = document.getElementById('themeSelect');

            // Remove existing theme classes
            body.classList.remove('high-contrast');
            body.classList.remove('light');

            // Add new theme class if needed
            if (theme === 'high-contrast') {
                body.classList.add('high-contrast');
            } else if (theme === 'light') {
                body.classList.add('light');
            }

            // Update dropdown selection
            themeSelect.value = theme;

            // Save preference to localStorage
            localStorage.setItem('theme', theme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);
        }

        // Load saved theme on page load
        document.addEventListener('DOMContentLoaded', loadTheme);
    </script>
</body>
</html>
