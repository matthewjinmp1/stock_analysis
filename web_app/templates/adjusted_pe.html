{% extends "base.html" %}

{% block title %}Adjusted PE Breakdown - {{ ticker }}{% endblock %}

{% block container_style %}max-width: 1000px;{% endblock %}

{% block extra_css %}
<style>
    .content {
        padding: 20px 40px 40px;
    }

    .card h2 {
        color: var(--text-secondary);
        margin-bottom: 20px;
        font-size: 1.5em;
    }

    .card .value {
        font-size: 3em;
        font-weight: 700;
        color: var(--accent-secondary);
        margin-bottom: 10px;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: left; }
    th { background: var(--table-header-bg); color: var(--text-secondary); font-weight: 600; }
    tr:hover td { background: var(--table-hover-bg); }
    .label { color: var(--text-secondary); font-weight: 500; }
    .muted { color: var(--text-muted); font-size: 0.9em; margin-top: 5px; }
    .error { color: var(--accent-danger); text-align: center; padding: 20px; background: var(--button-bg); border-radius: 8px; border: 1px solid var(--accent-danger); }
    .loading { text-align: center; padding: 20px; color: var(--text-muted); }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>Adjusted PE Breakdown</h1>
    <p>{{ ticker }}</p>
    <button onclick="history.back()" class="back-link">‚Üê Back</button>
</div>
<div class="content" id="content">
    <div class="loading">Loading...</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const ticker = '{{ ticker }}';

    function fmt(value, decimals = 2) {
        if (value === null || value === undefined) return 'N/A';
        const num = Number(value);
        if (Number.isNaN(num)) return 'N/A';
        return num.toFixed(decimals);
    }

    function fmtPercent(value, decimals = 2) {
        if (value === null || value === undefined) return 'N/A';
        return (value * 100).toFixed(decimals) + '%';
    }

    function fmtSuffix(value, decimals = 2) {
        if (value === null || value === undefined) return 'N/A';
        const num = Number(value);
        if (Number.isNaN(num)) return 'N/A';
        const abs = Math.abs(num);
        let suffix = '';
        let scaled = num;
        if (abs >= 1_000_000_000) {
            scaled = num / 1_000_000_000;
            suffix = 'B';
        } else if (abs >= 1_000_000) {
            scaled = num / 1_000_000;
            suffix = 'M';
        } else if (abs >= 1_000) {
            scaled = num / 1_000;
            suffix = 'K';
        }
        return scaled.toFixed(decimals) + suffix;
    }

    function fmtMoney(value, decimals = 2) {
        if (value === null || value === undefined) return 'N/A';
        const num = Number(value);
        if (Number.isNaN(num)) return 'N/A';
        return '$' + fmtSuffix(num, decimals);
    }

    function render(data) {
        const contentDiv = document.getElementById('content');
        const ratio = data.adjusted_pe_ratio;
        const b = data.breakdown || {};

        const fields = [
            // Step 1: Base TTM operating income calculation
            { label: 'TTM Operating Income', value: fmtMoney(b.ttm_operating_income) },
            { label: 'TTM Depreciation & Amortization (DA)', value: fmtMoney(b.ttm_da) },
            { label: 'TTM Capex', value: fmtMoney(b.ttm_capex) },
            { label: 'Adjustment (if DA exceeds Capex)', value: fmtMoney(b.adjustment) },
            { label: 'Adjusted Operating Income', value: fmtMoney(b.adjusted_operating_income) },

            // Step 2: Apply tax rate
            { label: 'Median Tax Rate (5yr)', value: fmtPercent(b.median_tax_rate, 2) },
            { label: 'Adjusted Earnings', value: fmtMoney(b.adjusted_oi_after_tax) },

            // Step 3: Get QuickFS base data
            { label: 'QuickFS EV (latest)', value: fmtMoney(b.quickfs_ev) },
            { label: 'QuickFS Market Cap (latest)', value: fmtMoney(b.quickfs_market_cap) },
            { label: 'EV Difference (EV - Market Cap)', value: fmtMoney(b.ev_difference) },

            // Step 4: Get current market data
            { label: 'Share Count (latest QuickFS)', value: fmtSuffix(b.share_count, 2) },
            { label: 'Current Price (yfinance)', value: b.current_price !== undefined && b.current_price !== null ? '$' + fmt(b.current_price) : 'N/A' },

            // Step 5: Calculate updated market cap
            { label: 'Updated Market Cap', value: fmtMoney(b.updated_market_cap) },

            // Step 6: Final EV Adjustment
            { label: 'Updated EV (with current price)', value: fmtMoney(b.updated_ev) },
        ];

        contentDiv.innerHTML = `
            <div class="card">
                <h2>Adjusted PE Ratio</h2>
                <div class="value">${ratio !== null && ratio !== undefined ? fmt(ratio) : 'N/A'}</div>
                <div class="muted">Click any ticker to recalculate from QuickFS/yfinance if data is missing.</div>
            </div>
            <div class="card">
                <h2>TTM Components</h2>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Item</th><th>Value</th></tr></thead>
                        <tbody>
                            ${fields.map(f => `<tr><td class="label">${f.label}</td><td>${f.value}</td></tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    fetch(`/api/adjusted_pe/${ticker}`)
        .then(r => r.json())
        .then(res => {
            const contentDiv = document.getElementById('content');
            if (!res.success) {
                contentDiv.innerHTML = `<div class="error">${res.message || 'Adjusted PE data not available'}</div>`;
                return;
            }
            render(res);
        })
        .catch(err => {
            document.getElementById('content').innerHTML = `<div class="error">Error: ${err.message}</div>`;
        });
</script>
{% endblock %}
