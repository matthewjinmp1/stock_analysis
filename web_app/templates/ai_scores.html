{% extends "base.html" %}

{% block title %}AI Scores - Stock Analysis{% endblock %}

{% block container_style %}max-width: 1400px;{% endblock %}

{% block extra_css %}
<style>
    .header {
        background: var(--header-bg);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        box-shadow: 0 0 15px var(--shadow-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header h1 {
        font-size: 2em;
        color: var(--text-secondary);
        text-shadow: 0 0 8px var(--glow-primary);
    }

    .back-link {
        display: inline-block;
        color: var(--text-secondary);
        text-decoration: none;
        padding: 10px 20px;
        background: var(--button-bg);
        border-radius: 8px;
        border: 1px solid var(--border-color);
        transition: all 0.3s;
        cursor: pointer;
        box-shadow: 0 0 8px var(--shadow-color);
    }

    .back-link:hover {
        background: rgba(from var(--accent-primary) r g b / 0.2);
        border-color: var(--accent-primary);
        box-shadow: 0 0 12px var(--glow-primary);
        color: var(--accent-primary);
    }

    .controls-section {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        box-shadow: 0 0 15px var(--shadow-color);
    }

    .search-container {
        margin-bottom: 20px;
        text-align: center;
    }

    .search-input {
        width: 100%;
        max-width: 400px;
        padding: 12px 20px;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-secondary);
        font-size: 1em;
        outline: none;
        box-shadow: 0 0 8px var(--shadow-inset);
    }

    .search-input:focus {
        border-color: var(--accent-secondary);
        box-shadow: 0 0 15px var(--glow-secondary);
    }

    .metrics-toggle-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
    }

    .metric-toggle {
        display: flex;
        align-items: center;
        gap: 5px;
        background: var(--bg-primary);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
    }

    .metric-toggle:hover {
        background: var(--button-bg);
        border-color: var(--accent-primary);
    }

    .metric-toggle.active {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
        color: #fff;
    }

    .scores-section {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 20px;
        border: 1px solid var(--border-color);
        box-shadow: 0 0 15px var(--shadow-color);
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        color: var(--text-primary);
    }

    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid rgba(from var(--border-color) r g b / 0.3);
        white-space: nowrap;
    }

    th {
        background: var(--table-header-bg);
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85em;
        letter-spacing: 0.05em;
        cursor: pointer;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    th:hover {
        background: var(--table-hover-bg);
    }

    th.sort-asc::after {
        content: " ‚Üë";
        color: var(--accent-secondary);
    }

    th.sort-desc::after {
        content: " ‚Üì";
        color: var(--accent-secondary);
    }

    tr:hover td {
        background: var(--table-hover-bg);
    }

    .ticker {
        font-weight: 700;
        color: var(--accent-secondary);
        text-decoration: none;
    }

    .ticker:hover {
        text-decoration: underline;
        color: var(--accent-primary);
    }

    .company-name {
        color: var(--text-secondary);
        font-size: 0.9em;
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .percentile-rank {
        font-weight: 600;
        color: var(--text-secondary);
        text-align: center;
    }

    .score-val {
        text-align: center;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
    }

    .spinner {
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--accent-primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
        box-shadow: 0 0 12px var(--glow-primary);
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>üìä AI Analysis Scores</h1>
    <a href="/" class="back-link">‚Üê Main Page</a>
</div>

<div class="controls-section">
    <div class="search-container">
        <input type="text" id="tickerSearch" class="search-input" placeholder="Search by ticker or company name..." onkeyup="filterAndRender()">
    </div>
    
    <p style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px; font-weight: 600;">Select Metrics to Show:</p>
    <div id="metricsToggle" class="metrics-toggle-container">
        <!-- Toggle buttons will be generated here -->
    </div>
</div>

<div class="scores-section">
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading scores from AI database...</p>
    </div>
    <table id="scoresTable" style="display: none;">
        <thead id="tableHead">
            <!-- Table header will be generated here -->
        </thead>
        <tbody id="scoresBody">
            <!-- Data will be loaded here -->
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allScores = [];
    let currentSort = { column: 'total_score_percentile_rank', direction: 'desc' };
    
    const METRIC_LABELS = {
        'moat_score': 'Economic Moat',
        'barriers_score': 'Barriers to Entry',
        'disruption_risk': 'Disruption Risk',
        'switching_cost': 'Switching Cost',
        'brand_strength': 'Brand Strength',
        'competition_intensity': 'Competition Intensity',
        'network_effect': 'Network Effect',
        'product_differentiation': 'Product Differentiation',
        'innovativeness_score': 'Innovativeness',
        'growth_opportunity': 'Growth Opportunity',
        'riskiness_score': 'Business Risk',
        'pricing_power': 'Pricing Power',
        'ambition_score': 'Ambition',
        'bargaining_power_of_customers': 'Customer Power',
        'bargaining_power_of_suppliers': 'Supplier Power',
        'product_quality_score': 'Product Quality',
        'culture_employee_satisfaction_score': 'Employee Culture',
        'trailblazer_score': 'Market Leadership',
        'management_quality_score': 'Management Quality',
        'size_well_known_score': 'Company Size',
        'ethical_healthy_environmental_score': 'Ethical/ESG',
        'long_term_orientation_score': 'Long Term Focus'
    };

    // Default visible metrics (none selected by default)
    let visibleMetrics = [];

    document.addEventListener('DOMContentLoaded', () => {
        initToggles();
        fetchScores();
    });

    function initToggles() {
        const container = document.getElementById('metricsToggle');
        Object.keys(METRIC_LABELS).forEach(key => {
            const toggle = document.createElement('div');
            toggle.className = `metric-toggle ${visibleMetrics.includes(key) ? 'active' : ''}`;
            toggle.textContent = METRIC_LABELS[key];
            toggle.onclick = () => toggleMetric(key, toggle);
            container.appendChild(toggle);
        });
    }

    function toggleMetric(key, element) {
        if (visibleMetrics.includes(key)) {
            visibleMetrics = visibleMetrics.filter(m => m !== key);
            element.classList.remove('active');
        } else {
            visibleMetrics.push(key);
            element.classList.add('active');
        }
        renderTable();
    }

    function fetchScores() {
        fetch('/api/ai_scores')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allScores = data.scores;
                    renderTable();
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('scoresTable').style.display = 'table';
                } else {
                    alert('Error loading scores: ' + data.message);
                }
            })
            .catch(err => {
                alert('Error fetching scores: ' + err.message);
            });
    }

    function sortData(scores) {
        return [...scores].sort((a, b) => {
            let valA = a[currentSort.column];
            let valB = b[currentSort.column];

            // Handle null/undefined
            if (valA === null || valA === undefined) valA = '';
            if (valB === null || valB === undefined) valB = '';

            // Handle numeric comparison if both are numbers (or numeric strings)
            const isNumA = typeof valA === 'number' || (typeof valA === 'string' && valA !== '' && !isNaN(valA));
            const isNumB = typeof valB === 'number' || (typeof valB === 'string' && valB !== '' && !isNaN(valB));

            if (isNumA && isNumB) {
                const numA = parseFloat(valA);
                const numB = parseFloat(valB);
                if (numA < numB) return currentSort.direction === 'asc' ? -1 : 1;
                if (numA > numB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            }

            // Default to string comparison
            const strA = String(valA).toLowerCase();
            const strB = String(valB).toLowerCase();

            if (strA < strB) return currentSort.direction === 'asc' ? -1 : 1;
            if (strA > strB) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });
    }

    function handleSort(column) {
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'desc';
        }
        renderTable();
    }

    function filterAndRender() {
        renderTable();
    }

    function displayVal(val) {
        if (val === null || val === undefined || val === '') return 'N/A';
        return val;
    }

    function renderTable() {
        const head = document.getElementById('tableHead');
        const body = document.getElementById('scoresBody');
        const filter = document.getElementById('tickerSearch').value.toUpperCase();
        
        // Filter scores
        let scoresToDisplay = allScores.filter(score => 
            score.ticker.toUpperCase().includes(filter) || 
            (score.company_name && score.company_name.toUpperCase().includes(filter))
        );

        // Sort scores
        scoresToDisplay = sortData(scoresToDisplay);

        // Render Header
        let headHTML = '<tr>';
        headHTML += `<th class="${currentSort.column === 'ticker' ? 'sort-' + currentSort.direction : ''}" onclick="handleSort('ticker')">Ticker</th>`;
        headHTML += `<th class="${currentSort.column === 'company_name' ? 'sort-' + currentSort.direction : ''}" onclick="handleSort('company_name')">Company</th>`;
        headHTML += `<th class="${currentSort.column === 'total_score_percentile_rank' ? 'sort-' + currentSort.direction : ''}" onclick="handleSort('total_score_percentile_rank')">Percentile</th>`;
        
        visibleMetrics.forEach(m => {
            headHTML += `<th class="score-val ${currentSort.column === m ? 'sort-' + currentSort.direction : ''}" onclick="handleSort('${m}')">${METRIC_LABELS[m]}</th>`;
        });
        headHTML += '</tr>';
        head.innerHTML = headHTML;

        // Render Body
        body.innerHTML = '';
        scoresToDisplay.forEach(score => {
            let rowHTML = `
                <td><a href="/?q=${score.ticker}" class="ticker">${score.ticker}</a></td>
                <td class="company-name" title="${score.company_name || ''}">${displayVal(score.company_name)}</td>
                <td class="percentile-rank">${displayVal(score.total_score_percentile_rank)}</td>
            `;
            
            visibleMetrics.forEach(m => {
                rowHTML += `<td class="score-val">${displayVal(score[m])}</td>`;
            });
            
            const row = document.createElement('tr');
            row.innerHTML = rowHTML;
            body.appendChild(row);
        });
    }
</script>
{% endblock %}
