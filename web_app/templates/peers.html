{% extends "base.html" %}

{% block title %}Peer Comparison - {{ ticker }}{% endblock %}

{% block container_style %}max-width: 1400px;{% endblock %}

{% block extra_css %}
<style>
    .content {
        padding: 20px 40px 40px;
    }

    .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: var(--bg-primary);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 15px var(--shadow-color);
    }

    .comparison-table th {
        background: var(--table-header-bg);
        color: var(--text-secondary);
        padding: 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
        position: relative;
    }

    .comparison-table th:hover {
        background: var(--table-hover-bg);
    }

    .comparison-table th.sortable::after {
        content: ' ⇅';
        opacity: 0.5;
        font-size: 0.8em;
        margin-left: 5px;
    }

    .comparison-table th.sort-asc::after {
        content: ' ↑';
        opacity: 1;
        color: var(--accent-primary);
    }

    .comparison-table th.sort-desc::after {
        content: ' ↓';
        opacity: 1;
        color: var(--accent-primary);
    }

    .comparison-table td {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-secondary);
        background: var(--bg-primary);
    }

    .comparison-table tr:hover td {
        background: var(--table-hover-bg);
    }

    .main-ticker-row td {
        background: var(--bg-secondary) !important;
        font-weight: 600;
        border-top: 2px solid var(--accent-secondary);
        border-bottom: 2px solid var(--accent-secondary);
    }

    .ticker-link {
        color: var(--accent-secondary);
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s;
    }

    .ticker-link:hover {
        color: var(--accent-primary);
        text-decoration: underline;
    }

    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: var(--text-muted);
        background: var(--bg-tertiary);
        border-radius: 15px;
        border: 1px solid var(--border-color);
        box-shadow: 0 0 15px var(--shadow-color);
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>Peer Comparison</h1>
    <p>Comparing {{ ticker }} with its peers</p>
    <button onclick="history.back()" class="back-link">← Back</button>
</div>
<div class="content">
    <div id="peer-content">
        <div class="loading">
            <div class="spinner"></div>
            <p id="loading-message">Loading peer data from database...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const ticker = '{{ ticker }}';

    // Sorting state
    let currentSortColumn = null;
    let currentSortDirection = 'asc'; // 'asc' or 'desc'
    let peerData = null; // Store the original data

    function loadPeerData() {
        // Set a timeout to update the message if it takes longer than expected
        // (indicating AI generation is likely happening)
        const aiTimeout = setTimeout(() => {
            const msgElement = document.getElementById('loading-message');
            if (msgElement) {
                msgElement.innerHTML = `
                    Generating AI peer recommendations for ${ticker}...<br>
                    <span style="font-size: 0.85em; color: var(--text-muted); margin-top: 8px; display: block;">
                        No existing peers found. AI is analyzing the market to find the best matches.
                        This typically takes 20-30 seconds.
                    </span>
                `;
            }
        }, 2000); // Show AI message after 2 seconds

        fetch(`/api/peers/${ticker}`)
            .then(response => response.json())
            .then(data => {
                // Clear the AI timeout since we got a response
                clearTimeout(aiTimeout);
                
                if (!data.success) {
                    const contentDiv = document.getElementById('peer-content');
                    contentDiv.innerHTML = `
                        <div class="empty-state">
                            <p>${data.message || 'Error loading peer data'}</p>
                        </div>
                    `;
                    return;
                }

                // Store the data globally for sorting
                peerData = data;

                // Initialize with main ticker first (default view)
                peerData.sortedCompanies = [data.main_ticker, ...(data.peers || [])];

                // Render the table
                renderPeerTable();
            })
            .catch(err => {
                clearTimeout(aiTimeout);
                const contentDiv = document.getElementById('peer-content');
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <p>Error loading peer data: ${err.message}</p>
                    </div>
                `;
            });
    }

    // Sorting functions
    function sortTable(column) {
        if (!peerData) return;

        // If clicking the same column, toggle direction
        if (currentSortColumn === column) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortColumn = column;
            currentSortDirection = 'asc';
        }

        // Create combined array of main ticker + peers for sorting
        const allCompanies = [peerData.main_ticker, ...peerData.peers];

        // Sort the combined array
        allCompanies.sort((a, b) => {
            let aVal = getSortValue(a, column);
            let bVal = getSortValue(b, column);

            // Handle null/undefined values
            if (aVal == null && bVal == null) return 0;
            if (aVal == null) return currentSortDirection === 'asc' ? 1 : -1;
            if (bVal == null) return currentSortDirection === 'asc' ? -1 : 1;

            // Convert to numbers if they're numeric
            if (typeof aVal === 'string' && !isNaN(aVal) && aVal !== '') {
                aVal = parseFloat(aVal);
            }
            if (typeof bVal === 'string' && !isNaN(bVal) && bVal !== '') {
                bVal = parseFloat(bVal);
            }

            if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        // Store the sorted companies (main ticker will be somewhere in this array)
        peerData.sortedCompanies = allCompanies;

        // Re-render the table
        renderPeerTable();
    }

    function getSortValue(obj, column) {
        switch (column) {
            case 'ticker':
                return obj.ticker || '';
            case 'company_name':
                return obj.company_name || '';
            case 'total_score_percentile_rank':
                return obj.total_score_percentile_rank;
            case 'financial_total_percentile':
                return obj.financial_total_percentile;
            case 'adjusted_pe_ratio':
                return obj.adjusted_pe_ratio;
            case 'short_float':
                // Parse percentage string to number for proper sorting
                if (obj.short_float && typeof obj.short_float === 'string') {
                    const percentMatch = obj.short_float.match(/(\d+(?:\.\d+)?)/);
                    return percentMatch ? parseFloat(percentMatch[1]) : 0;
                }
                return obj.short_float || 0;
            default:
                return obj[column];
        }
    }

    function renderPeerTable() {
        if (!peerData) return;

        const contentDiv = document.getElementById('peer-content');
        const mainTicker = peerData.main_ticker;
        const peers = peerData.peers || [];

        if (peers.length === 0) {
            contentDiv.innerHTML = `
                <div class="empty-state">
                    <p>No peers found for ${ticker}</p>
                </div>
            `;
            return;
        }

        // Use sorted companies if available, otherwise use original order
        const companiesToRender = peerData.sortedCompanies || [mainTicker, ...peers];

        let tableHTML = `
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th class="sortable${currentSortColumn === 'ticker' ? ' sort-' + currentSortDirection : ''}" onclick="sortTable('ticker')">Ticker</th>
                        <th class="sortable${currentSortColumn === 'company_name' ? ' sort-' + currentSortDirection : ''}" onclick="sortTable('company_name')">Company Name</th>
                        <th class="sortable${currentSortColumn === 'total_score_percentile_rank' ? ' sort-' + currentSortDirection : ''}" onclick="sortTable('total_score_percentile_rank')">Total Score</th>
                        <th class="sortable${currentSortColumn === 'financial_total_percentile' ? ' sort-' + currentSortDirection : ''}" onclick="sortTable('financial_total_percentile')">Financial Score</th>
                        <th class="sortable${currentSortColumn === 'adjusted_pe_ratio' ? ' sort-' + currentSortDirection : ''}" onclick="sortTable('adjusted_pe_ratio')">Adjusted PE Ratio</th>
                        <th class="sortable${currentSortColumn === 'short_float' ? ' sort-' + currentSortDirection : ''}" onclick="sortTable('short_float')">Short Float</th>
                    </tr>
                </thead>
                <tbody>
        `;

        companiesToRender.forEach(company => {
            // Check if this is the main ticker (searched stock) for highlighting
            const isMainTicker = company === mainTicker;
            const rowClass = isMainTicker ? 'main-ticker-row' : '';

            // Only show ticker link if ticker exists
            const tickerCell = company.ticker
                ? `<a href="/?q=${company.ticker}" class="ticker-link">${company.ticker}</a>`
                : 'N/A';

            // Use ticker for links only if it exists
            const linkTicker = company.ticker || company.company_name;

            tableHTML += `
                <tr class="${rowClass}">
                    <td>${tickerCell}</td>
                    <td>${company.company_name || 'N/A'}</td>
                    <td>${company.total_score_percentile_rank !== null
                        ? `<a href="/metrics/${linkTicker}" class="score-link">${company.total_score_percentile_rank}%</a>`
                        : 'N/A'}</td>
                    <td>${company.financial_total_percentile !== null
                        ? `<a href="/financial/${linkTicker}" class="score-link">${Math.round(company.financial_total_percentile)}%</a>`
                        : 'N/A'}</td>
                    <td>${company.adjusted_pe_ratio !== null && company.adjusted_pe_ratio !== undefined
                        ? `<a href="/adjusted_pe/${linkTicker}" class="score-link">${company.adjusted_pe_ratio.toFixed(2)}</a>`
                        : 'N/A'}</td>
                    <td>${company.short_float || 'N/A'}</td>
                </tr>
            `;
        });

        tableHTML += `
                </tbody>
            </table>
        `;

        contentDiv.innerHTML = tableHTML;
    }

    // Load data on page load
    loadPeerData();
</script>
{% endblock %}
